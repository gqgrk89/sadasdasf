local RunService = game:GetService("RunService")
local Players = game:GetService("Players")

local teleportPosition = Vector3.new(0, -200000, 0)
local attackDelay = 0.3
local tridentDelay = 0.9
local teleportDuration = 0.5
local cooldownTime = 5
-- 新增 Buddha2Pickup 的延迟配置（和 attackDelay 一致为 0.3 秒）
local buddha2PickupDelay = 0.3

local localPlayer = Players.LocalPlayer
local currentCharacter = nil
local isTeleporting = false
local delayConnection = nil
local cooldownActive = false

local function loopTeleportSelf(hrp)
    if not hrp or hrp:IsA("BasePart") == false or isTeleporting then
        return
    end

    isTeleporting = true
    local startTime = os.clock()
    print("开始持续传送，目标坐标: " .. tostring(teleportPosition) .. "，持续" .. teleportDuration .. "秒")

    local teleportConnection
    teleportConnection = RunService.Heartbeat:Connect(function()
        local elapsedTime = os.clock() - startTime
        if elapsedTime >= teleportDuration or not currentCharacter or currentCharacter.Parent == nil then
            teleportConnection:Disconnect()
            isTeleporting = false
            print("持续传送结束，共耗时: " .. string.format("%.3f", elapsedTime) .. "秒")
            return
        end

        hrp.CFrame = CFrame.new(teleportPosition)
    end)
end

local function setupCharacterDetection(character)
    if not character then return end
    currentCharacter = character

    local heartbeatConnection
    heartbeatConnection = RunService.Heartbeat:Connect(function()
        if not currentCharacter or currentCharacter.Parent == nil then
            heartbeatConnection:Disconnect()
            if delayConnection then
                task.cancel(delayConnection)
                delayConnection = nil
            end
            return
        end

        if cooldownActive or isTeleporting or delayConnection then
            return
        end

        local hrp = currentCharacter:FindFirstChild("HumanoidRootPart")
        if not hrp then return end

        -- 检测原有攻击标识
        local swordDanceAttack = hrp:FindFirstChild("SwordDanceAttack")
        local tridentDoughZ2 = hrp:FindFirstChild("TridentDoughZ2")
        -- 检测新增的 Buddha2Pickup 标识
        local buddha2Pickup = hrp:FindFirstChild("Buddha2Pickup")

        if swordDanceAttack or tridentDoughZ2 then
            local triggerName = swordDanceAttack and "SwordDanceAttack" or "TridentDoughZ2"
            local targetDelay = swordDanceAttack and attackDelay or tridentDelay
            
            cooldownActive = true
            print("检测到" .. triggerName .. "，立即启动" .. cooldownTime .. "秒冷却，将在" .. targetDelay .. "秒后执行传送")
            
            task.delay(cooldownTime, function()
                cooldownActive = false
                print(triggerName .. "触发的冷却结束，恢复检测")
            end)

            delayConnection = task.delay(targetDelay, function()
                loopTeleportSelf(hrp)
                delayConnection = nil
            end)
        -- 处理 Buddha2Pickup 逻辑：延迟 0.3 秒传送
        elseif buddha2Pickup then
            local triggerName = "Buddha2Pickup"
            local targetDelay = buddha2PickupDelay
            
            cooldownActive = true
            print("检测到" .. triggerName .. "，立即启动" .. cooldownTime .. "秒冷却，将在" .. targetDelay .. "秒后执行传送")
            
            -- 启动冷却计时
            task.delay(cooldownTime, function()
                cooldownActive = false
                print(triggerName .. "触发的冷却结束，恢复检测")
            end)

            -- 延迟 0.3 秒执行传送
            delayConnection = task.delay(targetDelay, function()
                loopTeleportSelf(hrp)
                delayConnection = nil
            end)
        end
    end)
end

localPlayer.CharacterAdded:Connect(setupCharacterDetection)

if localPlayer.Character then
    setupCharacterDetection(localPlayer.Character)
end

print("检测脚本已启动，监控本地玩家的 SwordDanceAttack/TridentDoughZ2/Buddha2Pickup 状态")
